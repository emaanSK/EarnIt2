<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EarnIt</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1164/1164620.png">
    <style>
        /* DISE√ëO LIMPIO Y MODERNO */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root { --primary: #00ff88; --bg: #000000; --surface: #1c1c1e; --input: #2c2c2e; --red: #ff453a; --accent: #ff9f0a; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: white; padding: 20px; margin: 0; padding-bottom: 50px;
            max-width: 500px; margin-left: auto; margin-right: auto;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -1px; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .streak { background: rgba(255, 159, 10, 0.2); color: var(--accent); padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; border: 1px solid rgba(255, 159, 10, 0.3); }

        .card { background: var(--surface); border-radius: 24px; padding: 25px 20px; margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        .label { color: #888; font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; display: block; }
        
        .time-display { font-size: 4rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums; line-height: 1; margin: 10px 0 20px; letter-spacing: -2px; text-shadow: 0 0 20px rgba(0,255,136,0.2); }
        
        /* BOTONES */
        .btn { border: none; padding: 16px; border-radius: 18px; font-weight: 700; font-size: 1rem; width: 100%; cursor: pointer; transition: transform 0.1s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:active { transform: scale(0.97); }
        .btn-main { background: var(--primary); color: #000; }
        .btn-use { background: var(--red); color: white; }
        .btn-pause { background: var(--accent); color: #000; }
        .btn-icon { background: var(--input); color: var(--primary); padding: 8px 14px; border-radius: 10px; font-size: 0.85rem; }
        .btn-del { background: transparent; color: #555; font-size: 1.2rem; padding: 10px; }

        /* INPUTS */
        .input-group { display: flex; flex-direction: column; gap: 12px; }
        input, select { background: var(--input); border: 1px solid transparent; padding: 15px; border-radius: 16px; color: white; font-size: 1rem; width: 100%; transition: 0.2s; }
        input:focus { border-color: var(--primary); background: #3a3a3c; }
        .row { display: flex; gap: 10px; }

        /* LISTA */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-item { background: var(--surface); padding: 18px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #2c2c2e; transition: all 0.3s; }
        .task-content b { display: block; font-size: 1.1rem; margin-bottom: 4px; }
        .task-status { font-size: 0.9rem; color: #888; font-family: "SF Pro Text", monospace; }
        .status-active { color: var(--accent); font-weight: bold; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1>EarnIt</h1>
        <div class="streak" id="streakDisplay">üî• 0 d√≠as</div>
    </div>

    <div class="card" style="text-align: center;">
        <span class="label">TIEMPO DISPONIBLE</span>
        <div class="time-display" id="balance">00:00:00</div>
        <button id="useBtn" class="btn btn-use" onclick="toggleUsage()">
            <span>üéÆ</span> CANJEAR TIEMPO
        </button>
    </div>

    <div class="card">
        <span class="label">NUEVA RUTINA</span>
        <div class="input-group">
            <select id="taskType" onchange="toggleInputs()">
                <option value="timer">‚è± Cron√≥metro (Estudio/Trabajo)</option>
                <option value="click">‚úÖ Tarea R√°pida (Cama/Platos)</option>
            </select>
            <input type="text" id="taskName" placeholder="Nombre de la tarea...">
            <div class="row">
                <input type="number" id="taskDuration" placeholder="Dura (min)">
                <input type="number" id="taskReward" placeholder="Ganas (min)">
            </div>
            <button class="btn btn-main" onclick="createTask()">+ A√ëADIR TAREA</button>
        </div>
    </div>

    <span class="label" style="margin-left: 10px; margin-bottom: 10px;">MIS TAREAS ACTIVAS</span>
    <div class="task-list" id="taskList"></div>

    <script>
        // --- BASE DE DATOS LOCAL ---
        let totalSeconds = parseInt(localStorage.getItem('totalSeconds')) || 0;
        let streak = parseInt(localStorage.getItem('streak')) || 0;
        let tasks = JSON.parse(localStorage.getItem('tasksArray')) || [];
        let isUsing = false;
        let interval = null;

        // --- FUNCIONES PRINCIPALES ---

        function updateDisplay() {
            // Formatear tiempo HH:MM:SS
            let h = Math.floor(totalSeconds / 3600);
            let m = Math.floor((totalSeconds % 3600) / 60);
            let s = totalSeconds % 60;
            document.getElementById('balance').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            // Guardar y actualizar racha
            localStorage.setItem('totalSeconds', totalSeconds);
            document.getElementById('streakDisplay').innerText = `üî• ${streak} d√≠as`;
        }

        function createTask() {
            const name = document.getElementById('taskName').value;
            const type = document.getElementById('taskType').value;
            const reward = document.getElementById('taskReward').value;
            const duration = type === 'click' ? 0 : document.getElementById('taskDuration').value;

            if (!name || !reward) return alert("Falta informaci√≥n");
            if (type === 'timer' && !duration) return alert("Falta la duraci√≥n");

            tasks.push({
                id: Date.now(),
                name,
                type,
                duration: parseInt(duration),
                reward: parseInt(reward),
                endTime: null
            });
            
            saveAndRender();
            // Limpiar campos
            document.getElementById('taskName').value = "";
            document.getElementById('taskDuration').value = "";
            document.getElementById('taskReward').value = "";
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = "";
            const now = Date.now();

            tasks.forEach(task => {
                let statusHtml = "";
                let btnHtml = "";

                if (task.type === 'click') {
                    statusHtml = `Premio: +${task.reward} min`;
                    btnHtml = `<button class="btn btn-icon" onclick="claimReward(${task.id})">‚úÖ Hecho</button>`;
                } else {
                    // L√≥gica del Cron√≥metro
                    if (task.endTime) {
                        if (now >= task.endTime) {
                            // Termin√≥
                            statusHtml = `<span style="color:#00ff88; font-weight:bold;">¬°COMPLETADO!</span>`;
                            btnHtml = `<button class="btn btn-icon" style="background:#00ff88; color:black;" onclick="claimReward(${task.id})">üí∞ Cobrar</button>`;
                        } else {
                            // Corriendo
                            const remaining = Math.ceil((task.endTime - now) / 1000);
                            const rm = Math.floor(remaining / 60);
                            const rs = (remaining % 60).toString().padStart(2, '0');
                            statusHtml = `<span class="status-active">‚è≥ ${rm}:${rs} restantes</span>`;
                            btnHtml = `<button class="btn btn-icon" style="opacity:0.5; cursor:default;">En curso...</button>`;
                        }
                    } else {
                        // Esperando iniciar
                        statusHtml = `${task.duration} min ‚Üí Ganas ${task.reward} min`;
                        btnHtml = `<button class="btn btn-icon" onclick="startTask(${task.id})">‚ñ∂Ô∏è Iniciar</button>`;
                    }
                }

                list.innerHTML += `
                    <div class="task-item">
                        <div class="task-content">
                            <b>${task.name}</b>
                            <div class="task-status">${statusHtml}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            ${btnHtml}
                            <button class="btn btn-del" onclick="deleteTask(${task.id})">‚úï</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- L√ìGICA DE NEGOCIO ---

        function startTask(id) {
            const task = tasks.find(t => t.id === id);
            task.endTime = Date.now() + (task.duration * 60000);
            saveAndRender();
        }

        function claimReward(id) {
            const task = tasks.find(t => t.id === id);
            totalSeconds += (task.reward * 60);
            
            // Gesti√≥n de Racha
            const today = new Date().toDateString();
            if (localStorage.getItem('lastDate') !== today) {
                streak++;
                localStorage.setItem('lastDate', today);
                localStorage.setItem('streak', streak);
            }

            // Resetear tarea
            if (task.type === 'timer') task.endTime = null;
            
            // Animaci√≥n visual simple
            alert(`¬°Genial! +${task.reward} minutos a√±adidos.`);
            
            saveAndRender();
            updateDisplay();
        }

        function toggleUsage() {
            if (!isUsing) {
                if (totalSeconds <= 0) return alert("¬°No tienes tiempo ahorrado!");
                isUsing = true;
                localStorage.setItem('usageStartTime', Date.now());
                document.getElementById('useBtn').innerHTML = "‚è∏ PAUSAR";
                document.getElementById('useBtn').classList.replace('btn-use', 'btn-pause');
                
                interval = setInterval(tickUsage, 1000);
            } else {
                stopUsage();
            }
        }

        function tickUsage() {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateDisplay();
            } else {
                stopUsage();
                alert("¬°TIEMPO AGOTADO!");
            }
        }

        function stopUsage() {
            isUsing = false;
            clearInterval(interval);
            localStorage.removeItem('usageStartTime');
            document.getElementById('useBtn').innerHTML = "<span>üéÆ</span> CANJEAR TIEMPO";
            document.getElementById('useBtn').classList.replace('btn-pause', 'btn-use');
        }

        // --- SINCRONIZACI√ìN MATEM√ÅTICA (Magia para iOS) ---
        // Esto recalcula todo cuando vuelves a abrir la app
        function syncState() {
            const now = Date.now();

            // 1. Recalcular Tiempo Gastado si estaba corriendo
            const usageStart = localStorage.getItem('usageStartTime');
            if (usageStart) {
                const secondsPassed = Math.floor((now - parseInt(usageStart)) / 1000);
                if (secondsPassed >= totalSeconds) {
                    totalSeconds = 0;
                    stopUsage();
                    alert("Se acab√≥ tu tiempo mientras estabas fuera.");
                } else {
                    totalSeconds -= secondsPassed;
                    localStorage.setItem('usageStartTime', now); // Resetear marca de tiempo
                    if (!isUsing) toggleUsage(); // Reactivar visualmente
                }
            }

            // 2. Refrescar tareas (para ver si ya terminaron)
            renderTasks();
            updateDisplay();
        }

        // --- UTILIDADES ---
        function deleteTask(id) {
            if (confirm("¬øBorrar tarea?")) {
                tasks = tasks.filter(t => t.id !== id);
                saveAndRender();
            }
        }
        function saveAndRender() {
            localStorage.setItem('tasksArray', JSON.stringify(tasks));
            renderTasks();
        }
        function toggleInputs() {
            const type = document.getElementById('taskType').value;
            const input = document.getElementById('taskDuration');
            input.style.display = type === 'click' ? 'none' : 'block';
        }

        // --- CICLO DE VIDA ---
        window.onload = () => {
            syncState();
            setInterval(renderTasks, 1000); // Refresca UI cada segundo sin l√≥gica pesada
        };
        
        // Detectar cuando vuelves a la app
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) syncState();
        });

    </script>
</body>
</html>
