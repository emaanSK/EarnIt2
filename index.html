<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EarnIt V10</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1164/1164620.png">
    <style>
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #00ff88; --bg: #000000; --card: #1c1c1e; --accent: #ff9d00; --red: #ff453a; --gray: #3a3a3c; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: white; padding: 20px; margin: 0; padding-bottom: 60px;
            max-width: 600px; margin-left: auto; margin-right: auto;
        }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px; }
        h1 { margin: 0; font-size: 1.8rem; letter-spacing: -1px; }
        .streak { background: #2c2c2e; padding: 6px 14px; border-radius: 20px; color: var(--accent); font-weight: 700; font-size: 0.9rem; border: 1px solid var(--gray); }

        /* INTERRUPTOR DE MODO FONDO */
        .mode-switch-container { 
            background: var(--card); padding: 15px; border-radius: 18px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border: 1px solid #333; 
        }
        .switch-label { font-size: 0.95rem; font-weight: 600; color: #fff; }
        .switch-sub { font-size: 0.75rem; color: #888; display: block; margin-top: 4px; line-height: 1.3; }
        
        .switch { position: relative; display: inline-block; width: 52px; height: 30px; flex-shrink: 0; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        .balance-card { background: var(--card); padding: 25px 20px; border-radius: 24px; text-align: center; margin-bottom: 25px; border: 1px solid #333; }
        .time-display { font-size: 3.8rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums; line-height: 1; letter-spacing: -2px; }
        .label-sm { color: #8e8e93; font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }

        .form-group { background: var(--card); padding: 20px; border-radius: 24px; margin-bottom: 25px; display: flex; flex-direction: column; gap: 12px; border: 1px solid #333; }
        input, select { background: #2c2c2e; border: 1px solid transparent; padding: 14px; border-radius: 14px; color: white; font-size: 1rem; width: 100%; }
        input:focus { border-color: var(--primary); background: var(--gray); }
        .row { display: flex; gap: 10px; }
        
        .btn { border: none; padding: 16px; border-radius: 16px; font-weight: 700; font-size: 1rem; cursor: pointer; width: 100%; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-add { background: var(--primary); color: black; }
        .btn-use { background: var(--red); color: white; margin-top: 15px; }
        .btn-pause { background: var(--accent); color: black; }

        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: var(--card); padding: 16px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .task-info { flex: 1; margin-right: 10px; }
        .task-info b { display: block; font-size: 1.05rem; }
        .task-info span { color: #8e8e93; font-size: 0.85rem; }
        .btn-action { background: var(--gray); color: var(--primary); padding: 10px 16px; border-radius: 12px; font-size: 0.9rem; font-weight: 600; border: none; }
        .btn-del { background: transparent; color: #555; font-size: 1.2rem; border: none; padding: 0 10px; }
        
        .timer-running { color: var(--accent) !important; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header">
        <h1>EarnIt V10</h1>
        <div class="streak" id="streakDisplay">üî• 0</div>
    </div>

    <div class="mode-switch-container">
        <div>
            <div class="switch-label">üîî Alerta en 2¬∫ Plano</div>
            <span class="switch-sub"><b>ON:</b> Avisa fuera de la app (Para m√∫sica).<br><b>OFF:</b> Compatible con Spotify (Avisa al volver).</span>
        </div>
        <label class="switch">
            <input type="checkbox" id="bgModeToggle" onchange="toggleBgMode()">
            <span class="slider"></span>
        </label>
    </div>

    <div class="balance-card">
        <div class="label-sm">TIEMPO DISPONIBLE</div>
        <div class="time-display" id="balance">00:00:00</div>
        <button id="useBtn" class="btn btn-use" onclick="toggleUsage()">CANJEAR TIEMPO</button>
    </div>
    
    <button id="notifBtn" style="background:none; border:none; color:#666; font-size:0.8rem; width:100%; margin-bottom:15px; text-decoration: underline;">üîî Probar Sonido (Tocar 1¬™ vez)</button>

    <div class="form-group">
        <div class="label-sm">NUEVA RUTINA</div>
        <select id="taskType" onchange="toggleInputs()">
            <option value="timer">‚è± Cron√≥metro (Trabajo + Premio)</option>
            <option value="click">‚úÖ Check (Solo Premio)</option>
        </select>
        <input type="text" id="taskName" placeholder="Nombre...">
        <div class="row">
            <input type="number" id="taskDuration" placeholder="Dura (min)">
            <input type="number" id="taskReward" placeholder="Ganas (min)">
        </div>
        <button class="btn btn-add" onclick="createTask()">+ A√ëADIR</button>
    </div>

    <div class="label-sm" style="margin-left: 5px; margin-bottom: 10px;">MIS TAREAS</div>
    <div class="task-list" id="taskList"></div>

    <audio id="silentAudio" loop playsinline>
        <source src="data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIwAHCwwRFh4iJSksLzI2Oi8xMzy/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/AAAADExhdmM1Ny42NC4xMDIAAAAAAAAAAAAAAAINAAAAAAAAAAAAAAAAAAAAAA==" type="audio/mpeg">
    </audio>

    <script>
        // --- CONFIGURACI√ìN ---
        let totalSeconds = parseInt(localStorage.getItem('totalSeconds')) || 0;
        let streak = parseInt(localStorage.getItem('streak')) || 0;
        let tasks = JSON.parse(localStorage.getItem('tasksArray')) || [];
        let bgMode = localStorage.getItem('bgMode') === 'true'; 
        let mainInterval;
        let isUsing = false;

        // Inicializar Switch
        document.getElementById('bgModeToggle').checked = bgMode;

        // --- GESTI√ìN DE SEGUNDO PLANO ---
        const silentAudio = document.getElementById('silentAudio');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function toggleBgMode() {
            bgMode = document.getElementById('bgModeToggle').checked;
            localStorage.setItem('bgMode', bgMode);
            
            if (bgMode) {
                // Si activa el modo, y hay algo corriendo, activamos audio ya
                if (isUsing || tasks.some(t => t.endTime)) keepAwake();
                alert("Modo 2¬∫ Plano ACTIVADO.\nLa app se mantendr√° viva y te avisar√° fuera.\n(La m√∫sica externa se pausar√°).");
            } else {
                // Si desactiva, soltamos el audio
                silentAudio.pause();
                if('mediaSession' in navigator) navigator.mediaSession.playbackState = "none";
            }
        }

        function keepAwake() {
            if (bgMode && silentAudio.paused) {
                silentAudio.play().catch(() => {});
            }
        }

        function playBeep() {
            // Sonido fuerte para la alarma
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // Sonido tipo "Alarma Digital"
            osc.type = 'square';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.setValueAtTime(800, audioCtx.currentTime + 0.2);
            osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.4);
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.8);
        }

        document.getElementById('notifBtn').onclick = () => {
            Notification.requestPermission();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            playBeep();
        };

        function sendNotification(title, body) {
            // Intenta enviar notificaci√≥n visual
            if (Notification.permission === 'granted') {
                new Notification(title, { body: body });
            }
            // Siempre emite sonido y vibraci√≥n
            playBeep();
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
        }

        // --- L√ìGICA DE TIEMPO ---
        function updateDisplay() {
            let h = Math.floor(totalSeconds / 3600);
            let m = Math.floor((totalSeconds % 3600) / 60);
            let s = totalSeconds % 60;
            const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            document.getElementById('balance').innerText = timeStr;
            localStorage.setItem('totalSeconds', totalSeconds);
            document.getElementById('streakDisplay').innerText = `üî• ${streak}`;
            
            // Si est√° en modo background y consumiendo tiempo, mostramos en widget
            if(bgMode && isUsing && 'mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({ title: "Tiempo Libre", artist: `Quedan: ${timeStr}` });
                navigator.mediaSession.playbackState = "playing";
            }
        }

        function createTask() {
            const name = document.getElementById('taskName').value;
            const type = document.getElementById('taskType').value;
            const reward = document.getElementById('taskReward').value;
            const duration = type === 'click' ? 0 : document.getElementById('taskDuration').value;

            if (!name || !reward) return alert("Faltan datos");
            if (type === 'timer' && !duration) return alert("Falta duraci√≥n");

            tasks.push({ 
                id: Date.now(), name, 
                duration: parseInt(duration), reward: parseInt(reward), 
                type, endTime: null, notified: false 
            });
            saveTasks(); renderTasks();
            
            document.getElementById('taskName').value = "";
            document.getElementById('taskReward').value = "";
            document.getElementById('taskDuration').value = "";
        }

        function renderTasks() {
            const container = document.getElementById('taskList');
            container.innerHTML = "";
            const now = Date.now();
            let anyRunning = false;

            tasks.forEach(task => {
                let status = "", btn = "", running = false;

                if (task.type === 'click') {
                    status = `Ganas: +${task.reward}m`; btn = "Check";
                } else {
                    if (task.endTime && task.endTime > now) {
                        // TAREA CORRIENDO
                        anyRunning = true;
                        let rem = Math.ceil((task.endTime - now) / 1000);
                        let m = Math.floor(rem/60);
                        let s = (rem%60).toString().padStart(2,'0');
                        status = `‚è≥ ${m}:${s}`; btn = "En curso..."; running = true;
                        
                        // Actualizar Widget si est√° activo
                        if(bgMode && 'mediaSession' in navigator) {
                            navigator.mediaSession.metadata = new MediaMetadata({ title: task.name, artist: `Termina en: ${m}:${s}` });
                            navigator.mediaSession.playbackState = "playing";
                        }
                    } else if (task.endTime && task.endTime <= now) {
                        // TAREA TERMINADA
                        status = "¬°LISTO!"; btn = "Cobrar";
                        if (!task.notified) {
                            sendNotification("‚úÖ ¬°Tarea Finalizada!", `${task.name} completada.`);
                            task.notified = true;
                            saveTasks();
                        }
                    } else {
                        status = `${task.duration}m ‚Üí ${task.reward}m`; btn = "Iniciar";
                    }
                }

                container.innerHTML += `
                    <div class="task-item">
                        <div class="task-info"><b>${task.name}</b><span class="${running?'timer-running':''}">${status}</span></div>
                        <div class="task-actions">
                            <button class="btn-action" onclick="handleTask(${task.id})" style="${btn==='Cobrar'?'background:var(--primary);color:black':''}" ${running?'disabled':''}>${btn}</button>
                            <button class="btn-del" onclick="deleteTask(${task.id})">‚úï</button>
                        </div>
                    </div>`;
            });

            // GESTI√ìN AUDIO
            if ((anyRunning || isUsing) && bgMode) {
                keepAwake();
            } else if (!anyRunning && !isUsing) {
                silentAudio.pause();
                if('mediaSession' in navigator) navigator.mediaSession.playbackState = "none";
            }
        }

        function handleTask(id) {
            const task = tasks.find(t => t.id === id);
            const now = Date.now();

            if (task.type === 'click') {
                claim(task.reward * 60);
            } else {
                if (!task.endTime || now > task.endTime) {
                    if (task.endTime && now > task.endTime) {
                        // COBRAR
                        claim(task.reward * 60);
                        task.endTime = null; task.notified = false;
                    } else {
                        // INICIAR
                        task.endTime = now + (task.duration * 60000);
                        task.notified = false;
                        if(bgMode) keepAwake();
                    }
                }
            }
            saveTasks(); renderTasks();
        }

        function claim(sec) {
            totalSeconds += sec;
            const today = new Date().toDateString();
            if (localStorage.getItem('lastDate') !== today) {
                streak++; localStorage.setItem('lastDate', today); localStorage.setItem('streak', streak);
            }
            updateDisplay();
        }

        function toggleUsage() {
            if (!isUsing) {
                if (totalSeconds <= 0) return alert("Sin saldo.");
                isUsing = true;
                localStorage.setItem('usageStartTime', Date.now());
                if(bgMode) keepAwake();
                
                const btn = document.getElementById('useBtn');
                btn.innerText = "PAUSAR"; btn.classList.add('btn-pause'); btn.classList.remove('btn-use');
                
                mainInterval = setInterval(() => {
                    if (totalSeconds > 0) {
                        totalSeconds--; updateDisplay();
                        if(totalSeconds === 0) {
                            sendNotification("üö® ¬°TIEMPO AGOTADO!", "Se acab√≥ el recreo.");
                            stopUsage();
                        }
                    } else stopUsage();
                }, 1000);
            } else stopUsage();
        }

        function stopUsage() {
            isUsing = false; clearInterval(mainInterval);
            localStorage.removeItem('usageStartTime');
            const btn = document.getElementById('useBtn');
            btn.innerText = "CANJEAR TIEMPO"; btn.classList.remove('btn-pause'); btn.classList.add('btn-use');
            if(bgMode) {
                silentAudio.pause();
                if('mediaSession' in navigator) navigator.mediaSession.playbackState = "none";
            }
            renderTasks();
        }

        function deleteTask(id) {
            if(confirm("¬øBorrar?")) { tasks = tasks.filter(t=>t.id!==id); saveTasks(); renderTasks(); }
        }
        function saveTasks() { localStorage.setItem('tasksArray', JSON.stringify(tasks)); }
        function toggleInputs() {
             const type = document.getElementById('taskType').value;
             document.getElementById('taskDuration').classList.toggle('hidden', type === 'click');
        }

        // SINCRONIZACI√ìN (Para cuando el modo background est√° APAGADO o falla)
        function sync() {
            const now = Date.now();
            
            // 1. Sync Tareas
            // No hacemos nada especial aqu√≠, renderTasks se encargar√° de ver si acab√≥ una tarea
            
            // 2. Sync Tiempo Libre (Timer Usage)
            const usageStart = localStorage.getItem('usageStartTime');
            if (usageStart) {
                const elapsed = Math.floor((now - parseInt(usageStart)) / 1000);
                // Si el tiempo real que pas√≥ es mayor a lo que quedaba
                if (elapsed >= totalSeconds) {
                    // Solo alertamos si NO se notific√≥ ya via background
                    if (totalSeconds > 0) { 
                         totalSeconds = 0;
                         alert("El tiempo se acab√≥ mientras estabas fuera.");
                    }
                    stopUsage();
                } else {
                    totalSeconds -= elapsed;
                    localStorage.setItem('usageStartTime', now);
                }
            }
            updateDisplay();
            renderTasks();
        }

        // BUCLE PRINCIPAL
        // Se ejecuta cada segundo para actualizar UI y chequear alarmas
        window.onload = () => { sync(); setInterval(renderTasks, 1000); };
        
        // Al volver a la app, forzamos sincronizaci√≥n matem√°tica por si acaso
        document.addEventListener("visibilitychange", () => { 
            if(!document.hidden) sync(); 
        });
    </script>
</body>
</html>

