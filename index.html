<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EarnIt V12</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1164/1164620.png">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root { --primary: #00ff88; --bg: #000000; --card: #1c1c1e; --red: #ff453a; --gray: #2c2c2e; }
        
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: white; padding: 20px; margin: 0; padding-bottom: 80px;
            max-width: 600px; margin-left: auto; margin-right: auto;
        }

        h1 { margin: 10px 0 20px; font-size: 1.8rem; text-align: center; letter-spacing: -1px; }

        /* BOTON DE ARRANQUE GIGANTE */
        .start-btn {
            background: #333; color: #aaa; border: 2px solid #444;
            width: 100%; padding: 20px; border-radius: 20px;
            font-size: 1.1rem; font-weight: 800; margin-bottom: 20px;
            cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .start-btn.active {
            background: var(--primary); color: black; border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .balance-card { background: var(--card); padding: 25px; border-radius: 24px; text-align: center; margin-bottom: 25px; border: 1px solid #333; }
        .time-display { font-size: 3.5rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums; line-height: 1; margin: 10px 0; }
        .label-sm { color: #888; font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 700; }

        .form-group { background: var(--card); padding: 15px; border-radius: 20px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; border: 1px solid #333; }
        input, select { background: var(--gray); border: 1px solid #333; padding: 12px; border-radius: 12px; color: white; font-size: 1rem; width: 100%; }
        
        .row { display: flex; gap: 10px; }
        .btn { border: none; padding: 15px; border-radius: 14px; font-weight: 700; font-size: 1rem; width: 100%; margin-top: 5px; cursor: pointer; }
        .btn-add { background: var(--primary); color: black; }
        .btn-use { background: var(--red); color: white; }
        .btn-pause { background: #ff9d00; color: black; }

        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: var(--card); padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .task-info b { display: block; font-size: 1rem; }
        .task-info span { color: #888; font-size: 0.85rem; }
        .btn-action { background: var(--gray); color: var(--primary); padding: 8px 14px; border-radius: 10px; font-size: 0.85rem; font-weight: 600; border: none; }
        .running { color: #ff9d00 !important; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>EarnIt V12</h1>

    <button id="initBtn" class="start-btn" onclick="startSystem()">
        <span>‚ñ∂Ô∏è</span> INICIAR SISTEMA DE SONIDO
    </button>
    <div style="text-align:center; font-size:0.75rem; color:#666; margin-top:-10px; margin-bottom:20px;">
        (Toca esto cada vez que abras la app para que funcione en 2¬∫ plano)
    </div>

    <div class="balance-card">
        <div class="label-sm">TIEMPO ACUMULADO</div>
        <div class="time-display" id="balance">00:00:00</div>
        <button id="useBtn" class="btn btn-use" onclick="toggleUsage()">CANJEAR TIEMPO</button>
    </div>

    <div class="form-group">
        <div class="label-sm">NUEVA TAREA</div>
        <select id="taskType" onchange="toggleInputs()">
            <option value="timer">‚è± Cron√≥metro</option>
            <option value="click">‚úÖ Check R√°pido</option>
        </select>
        <input type="text" id="taskName" placeholder="Nombre...">
        <div class="row">
            <input type="number" id="taskDuration" placeholder="Duraci√≥n (m)">
            <input type="number" id="taskReward" placeholder="Premio (m)">
        </div>
        <button class="btn btn-add" onclick="createTask()">A√ëADIR</button>
    </div>

    <div class="task-list" id="taskList"></div>

    <audio id="silentAudio" loop playsinline preload="auto">
        <source src="data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIwAHCwwRFh4iJSksLzI2Oi8xMzy/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/AAAADExhdmM1Ny42NC4xMDIAAAAAAAAAAAAAAAINAAAAAAAAAAAAAAAAAAAAAA==" type="audio/mpeg">
    </audio>

    <script>
        // --- INICIALIZACI√ìN DE AUDIO (CR√çTICO) ---
        const silentAudio = document.getElementById('silentAudio');
        const initBtn = document.getElementById('initBtn');
        let audioContext = null;
        let systemActive = false;

        function startSystem() {
            // 1. Crear el contexto de audio
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // 2. Intentar reproducir audio HTML5 (Silencio)
            // Esto es lo que mantiene la app viva en segundo plano
            const playPromise = silentAudio.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // √âXITO
                    systemActive = true;
                    initBtn.classList.add('active');
                    initBtn.innerHTML = "<span>üîä</span> SISTEMA ACTIVO";
                    
                    // 3. Forzar Session Metadata (Para que salga en pantalla bloqueo)
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: "EarnIt Activo",
                            artist: "Vigilando tiempo...",
                            artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/1164/1164620.png', sizes: '512x512', type: 'image/png' }]
                        });
                        navigator.mediaSession.playbackState = "playing";
                    }

                    // 4. Pedir permiso notificaciones si no se tiene
                    Notification.requestPermission();

                }).catch(error => {
                    // ERROR
                    console.error(error);
                    alert("iOS bloque√≥ el audio. \n\nSOLUCI√ìN:\n1. Cierra la app del todo.\n2. Vuelve a abrirla.\n3. Toca ESTE bot√≥n antes de hacer nada m√°s.");
                    initBtn.innerHTML = "‚ùå ERROR AL INICIAR";
                });
            }
            
            // 5. Resumir contexto WebAudio por si estaba suspendido
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // --- SISTEMA DE ALARMA ---
        function playLoudAlarm() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();

            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.connect(gain);
            gain.connect(audioContext.destination);

            // Sonido tipo SIRENA (Sube y baja)
            osc.type = 'sawtooth';
            const now = audioContext.currentTime;
            
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.linearRampToValueAtTime(900, now + 0.5);
            osc.frequency.linearRampToValueAtTime(600, now + 1.0);

            gain.gain.setValueAtTime(0.5, now);
            gain.gain.linearRampToValueAtTime(0, now + 2);

            osc.start();
            osc.stop(now + 2);

            if (navigator.vibrate) navigator.vibrate([1000]);
        }

        function notify(title, body) {
            playLoudAlarm();
            if (Notification.permission === 'granted') new Notification(title, { body });
        }

        // --- L√ìGICA DE TIEMPO (STANDARD) ---
        let totalSeconds = parseInt(localStorage.getItem('totalSeconds')) || 0;
        let streak = parseInt(localStorage.getItem('streak')) || 0;
        let tasks = JSON.parse(localStorage.getItem('tasksArray')) || [];
        let isUsing = false;
        let mainInterval;

        function updateDisplay() {
            let h = Math.floor(totalSeconds / 3600);
            let m = Math.floor((totalSeconds % 3600) / 60);
            let s = totalSeconds % 60;
            const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            document.getElementById('balance').innerText = timeStr;
            localStorage.setItem('totalSeconds', totalSeconds);
            
            // Actualizar Widget de bloqueo
            if(systemActive && 'mediaSession' in navigator) {
                if(isUsing) {
                    navigator.mediaSession.metadata.title = "CANJEANDO TIEMPO";
                    navigator.mediaSession.metadata.artist = `Quedan: ${timeStr}`;
                } else if (tasks.some(t => t.endTime > Date.now())) {
                    navigator.mediaSession.metadata.title = "TRABAJANDO";
                    navigator.mediaSession.metadata.artist = "Gana tu tiempo...";
                }
            }
        }

        function createTask() {
            const name = document.getElementById('taskName').value;
            const type = document.getElementById('taskType').value;
            const reward = document.getElementById('taskReward').value;
            const duration = type === 'click' ? 0 : document.getElementById('taskDuration').value;

            if (!name || !reward) return;
            tasks.push({ id: Date.now(), name, duration: parseInt(duration), reward: parseInt(reward), type, endTime: null, notified: false });
            saveTasks(); renderTasks();
            
            document.getElementById('taskName').value = "";
            document.getElementById('taskDuration').value = "";
            document.getElementById('taskReward').value = "";
        }

        function renderTasks() {
            const container = document.getElementById('taskList');
            container.innerHTML = "";
            const now = Date.now();

            tasks.forEach(task => {
                let status = "", btn = "", cls = "";
                
                if (task.type === 'click') {
                    status = `+${task.reward}m`; btn = "Cobrar";
                } else {
                    if (task.endTime && task.endTime > now) {
                        let rem = Math.ceil((task.endTime - now) / 1000);
                        let m = Math.floor(rem/60);
                        let s = (rem%60).toString().padStart(2,'0');
                        status = `‚è≥ ${m}:${s}`; btn = "Esperar..."; cls = "running";
                    } else if (task.endTime && task.endTime <= now) {
                        status = "¬°LISTO!"; btn = "Reclamar"; cls = "running";
                        if (!task.notified) {
                            notify("¬°TAREA COMPLETADA!", task.name);
                            task.notified = true;
                            saveTasks();
                        }
                    } else {
                        status = `${task.duration}m / ${task.reward}m`; btn = "Iniciar";
                    }
                }

                container.innerHTML += `
                <div class="task-item">
                    <div class="task-info"><b>${task.name}</b><span class="${cls}">${status}</span></div>
                    <div class="task-actions">
                        <button class="btn-action" onclick="handleTask(${task.id})" ${btn==='Esperar...'?'disabled':''}>${btn}</button>
                        <button class="btn-action" style="background:none; color:#666;" onclick="deleteTask(${task.id})">‚úï</button>
                    </div>
                </div>`;
            });

            // Si el sistema est√° activo pero el audio se paus√≥ (iOS lo mata a veces), intentar revivir
            if (systemActive && silentAudio.paused) silentAudio.play().catch(e => {});
        }

        function handleTask(id) {
            if(!systemActive) alert("‚ö†Ô∏è Recuerda pulsar 'INICIAR SISTEMA' arriba, o la alarma no sonar√° al bloquear.");
            const task = tasks.find(t => t.id === id);
            const now = Date.now();

            if (task.type === 'click') {
                addTime(task.reward * 60);
            } else {
                if (!task.endTime || now > task.endTime) {
                    if (task.endTime && now > task.endTime) {
                        addTime(task.reward * 60); task.endTime = null; task.notified = false;
                    } else {
                        task.endTime = now + (task.duration * 60000); task.notified = false;
                    }
                }
            }
            saveTasks(); renderTasks();
        }

        function toggleUsage() {
            if (!isUsing) {
                if (totalSeconds <= 0) return alert("No tienes tiempo.");
                if(!systemActive) alert("‚ö†Ô∏è ATENCI√ìN: Pulsa 'INICIAR SISTEMA' arriba primero.");
                
                isUsing = true;
                localStorage.setItem('usageStartTime', Date.now());
                document.getElementById('useBtn').innerText = "PAUSAR";
                document.getElementById('useBtn').classList.replace('btn-use', 'btn-pause');
                
                mainInterval = setInterval(() => {
                    if (totalSeconds > 0) {
                        totalSeconds--; updateDisplay();
                        if(totalSeconds === 0) {
                            notify("¬°TIEMPO AGOTADO!", "Se acab√≥ el recreo.");
                            stopUsage();
                        }
                    } else stopUsage();
                }, 1000);
            } else stopUsage();
        }

        function stopUsage() {
            isUsing = false; clearInterval(mainInterval);
            localStorage.removeItem('usageStartTime');
            document.getElementById('useBtn').innerText = "CANJEAR TIEMPO";
            document.getElementById('useBtn').classList.replace('btn-pause', 'btn-use');
        }

        function addTime(s) { totalSeconds += s; updateDisplay(); }
        function deleteTask(id) { if(confirm("¬øBorrar?")) { tasks = tasks.filter(t=>t.id!==id); saveTasks(); renderTasks(); }}
        function saveTasks() { localStorage.setItem('tasksArray', JSON.stringify(tasks)); }
        function toggleInputs() {
             const type = document.getElementById('taskType').value;
             document.getElementById('taskDuration').classList.toggle('hidden', type === 'click');
        }

        // Sync al volver
        function sync() {
            const now = Date.now();
            const start = localStorage.getItem('usageStartTime');
            if (start) {
                const elapsed = Math.floor((now - parseInt(start)) / 1000);
                if (elapsed >= totalSeconds) { totalSeconds = 0; stopUsage(); }
                else { totalSeconds -= elapsed; localStorage.setItem('usageStartTime', now); }
            }
            updateDisplay(); renderTasks();
        }

        window.onload = () => { sync(); setInterval(renderTasks, 1000); };
        document.addEventListener("visibilitychange", () => { if(!document.hidden) sync(); });

    </script>
</body>
</html>
